<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" class="next-head next-head"/><title class="next-head">Moondaddi&#x27;s Blog</title><link rel="preload" href="/_next/b071a135-2bb6-4443-8de0-74c936e64935/page/index.js" as="script"/><link rel="preload" href="/_next/b071a135-2bb6-4443-8de0-74c936e64935/page/_app.js" as="script"/><link rel="preload" href="/_next/b071a135-2bb6-4443-8de0-74c936e64935/page/_error.js" as="script"/><link rel="preload" href="/_next/static/commons/main-c5f62fe11b39d6908ec5.js" as="script"/><style id="__jsx-undefined">
html,
body {
  margin: 0;
  padding: 0;
  border: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  font-size: 1rem;
  font-weight: 300;
  line-height: 160%;
}
#layout {
  display: grid;
  grid-template-columns: 300px 1fr;
  grid-template-areas: "header header" "category content" "footer footer";
}
#footer {
  grid-area: footer;
  background-color: #eee;
}
#content {
  grid-area: content;
  display: grid;
  grid-template-columns: minmax(auto, 100px) 1fr minmax(auto, 100px);
  grid-template-areas: "left-span container right-span";
  padding: 50px 0px;
  background:
  radial-gradient(black 15%, transparent 16%) 0 0,
  radial-gradient(black 15%, transparent 16%) 8px 8px,
  radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px,
  radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;
  background-color:#282828;
  background-size:16px 16px;
}
@media (max-width: 576px) {
  #layout {
    display: grid;
    grid-template-columns: 1fr;
    grid-template-areas: "header" "content" "footer";
  }
  #content {
    grid-area: content;
    display: grid;
    grid-template-columns: 1fr;
    grid-template-areas: "container";
    padding: 50px 0px;
  }
  img {
    width: 100%;
  }
}
.container {
  grid-area: container;
  padding: 20px 10px 20px 10px;
  min-width: 0;
}

.add-padding-for-fixed-header {
  padding: 90px 10px 20px 10px;
}
</style><meta name="author" content="Moondaddi"/><link rel="manifest" href="/static/manifest.json"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossOrigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Build my dreams with codes"/><meta name="theme-color" content="black"/></head><body><div id="__next"><div id="layout"><div id="header"><div id="header-top"><div id="home"><div id="home-title"><a href="/">Build my Dreams with Codes</a></div><div id="home-title-sm"><a href="/">BDC</a></div></div><div id="menu"><a id="menu-about" href="/about/">About</a><i id="search-button-sm" class="fa fa-search"></i><div id="search-container-id" class="search-container"><span class="icon"><i class="fa fa-search"></i></span><input type="text" id="search" value=""/></div><div id="menu-button"><i class="fas fa-bars"></i></div></div></div></div><style jsx="true">
#menu-button {
  display: none;
}
#header #home-title {
  display: inline-block;
}
#header #home-title-sm {
  display: none;
}
#header {
  grid-area: header;
  background-color: #343d46;
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  z-index: 20;
}

#header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 72px;
}

.make-fixed {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
}

#header #home-title a {
  font-size: 1.2rem;
  font-weight: bold;
  text-decoration: none;
  color: #eee;
  margin: 0 10px;
  padding: 15px;
}

#header #home-title:hover a {
  cursor: pointer;
  color: #fff;
}

#header #home-title-sm a {
  font-size: 1.2rem;
  font-weight: bold;
  text-decoration: none;
  color: #eee;
  margin: 0 10px;
  padding: 15px;
}

#header #home-title-sm:hover a {
  cursor: pointer;
  color: #fff;
}

#header a#menu-about {
  display: inline-block;
  text-decoration: none;
  color: #eee;
  padding: 15px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

#header a#menu-about:hover {
  background-color: white;
  transition: 0.2s;
  cursor: pointer;
  color: #000;
  border-bottom: 4px solid #aaa;
  padding: 15px 15px 11px 15px;
}

#search-button-sm {
  color: #4f5b66;
  margin: 0px 10px;
  padding: 20px 15px 19px 15px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

#search-button-sm:hover {
  background-color: white;
  transition: 0.2s;
  cursor: pointer;
  color: #000;
  border-bottom: 4px solid #aaa;
  padding: 20px 15px 15px 15px;
}

#header a#home-title:hover {
  background-color: unset;
  color: #fff;
  transition: 0.2s;
}

.search-container{
  display: inline-block;
  vertical-align: middle;
  white-space: nowrap;
  position: relative;
  padding: 10px;
}

.search-container input#search{
  width: 20px;
  height: 50px;
  background: #2b303b;
  border: none;
  font-size: 1rem;
  float: left;
  color: #262626;
  padding-left: 35px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
  color: #2b303b;
 
  -webkit-transition: width .55s ease;
  -moz-transition: width .55s ease;
  -ms-transition: width .55s ease;
  -o-transition: width .55s ease;
  transition: width .55s ease;
}

.search-container input#search::-webkit-input-placeholder {
  color: #65737e;
}

.search-container input#search:-moz-placeholder { /* Firefox 18- */
  color: #65737e;  
}

.search-container input#search::-moz-placeholder {  /* Firefox 19+ */
  color: #65737e;  
}

.search-container input#search:-ms-input-placeholder {  
  color: #65737e;  
}

.search-container .icon{
  position: absolute;
  margin-left: 20px;
  margin-top: 15px;
  z-index: 1;
  color: #4f5b66;
}

.search-container:hover .icon,
.search-container input#search:focus .icon,
.search-container input#search:active .icon{
  margin-top: 17px;
  color: #93a2ad;
 
  -webkit-transform:scale(1.5); /* Safari and Chrome */
  -moz-transform:scale(1.5); /* Firefox */
  -ms-transform:scale(1.5); /* IE 9 */
  -o-transform:scale(1.5); /* Opera */
   transform:scale(1.5);
  }

.search-container input#search:focus,
.search-container input#search:active{
  outline:none;
  width: 150px;
  padding-left: 50px;
  color: white;
}
 
.search-container:hover input#search{
  width: 150px;
  padding-left: 50px;
  color: white;
}
 
.search-container:hover .icon{
  color: #93a2ad;
}
#header-bottom,
#search-button-sm {
  display: none;
}
@media (max-width: 576px) {
  #menu-button {
    display: inline-block;
    color: #eee;
    margin-right: 10px;
    padding: 15px;
    -webkit-border-radius: 5px;
    -moz-border-radius: 5px;
    border-radius: 5px;
  }
  #menu-button:hover {
    background-color: white;
    transition: 0.2s;
    cursor: pointer;
    color: #000;
    border-bottom: 4px solid #aaa;
    padding: 15px 15px 11px 15px;
  }
  #header #home-title {
    display: none;
  }
  #header #home-title-sm {
    display: inline-block;
  }
  #search-container-id {
    display: none;
  }
  #search-button-sm {
    display: inline-block;
  }
  #header-bottom {
    display: block;
  }
  .search-container {
    padding-top: 0px;
  }
  .search-container input#search{
    width: 200px;
    padding-left: 50px;
    color: white;
  }
  .search-container:hover input#search{
    width: 200px;
    padding-left: 50px;
    color: white;
  }
  .search-container input#search:focus,
  .search-container input#search:active{
    outline:none;
    width: 200px;
    padding-left: 50px;
    color: white;
  }
}
</style><div id="category"><div id="container-category"><div id="container-category-fixed"><div id="menu-close-button"><i class="fas fa-times"></i></div><a href="/post/react/"><span>React</span><span>3</span></a><a href="/post/django/"><span>Django</span><span>3</span></a><a href="/post/javascript/"><span>Javascript</span><span>0</span></a><a href="/post/python/"><span>Python</span><span>0</span></a><a href="/post/htmlcss/"><span>Html CSS</span><span>1</span></a><a href="/post/backend/"><span>Backend</span><span>2</span></a><a href="/post/devlogs/"><span>dev logs</span><span>4</span></a></div></div></div><style jsx="true">
#category,
#category__show {
  grid-area: category;
  background-color: #eee;
  padding: 15px 0;
}
.make-fixed-category {
  position: fixed;
  top: 87px;
  left: 0;
  width: 100%;
  display: grid;
  grid-template-columns: 300px 1fr;
  grid-template-areas: &quot;category-fixed content-fixed&quot;;
}
#container-category-fixed {
  grid-area: category-fixed;
}
#menu-close-button {
  display: none;
}
@media (max-width: 576px) {
  #category {
    display: none;
  }
  #category__show {
    grid-area: 2/1/3/2;
    z-index: 10;
    background-color: rgba(238, 238, 238, 0.97)
  }
  #menu-close-button {
    display: block;
    margin-right: 10px;
    padding: 10px;
    font-size: 2rem;
    color: #555;
    cursor: pointer;
    text-align: right;
  }
  .make-fixed-category {
    display: block;
  }
}
#category a,
#category__show a {
  display: flex;
  margin: 0;
  padding: 15px 30px;
  color: #555;
  text-decoration: none;
  justify-content: space-between;
}
#category a:hover,
#category__show a:hover {
  background-color: #ddd;
  transition: 0.5s
}

#category a#selected,
#category__show a#selected {
  color: #000;
  font-weight: bold;
}
</style><div id="content"><div class="container"><div><h2 class="index-h2-title">Latest Posts <i id="latest" class="fas fa-comment"></i></h2><div class="post-card"><div><h1>How to deploy the Next.js to AWS Lambda</h1><p>by moondaddi on 2019-01-11</p><hr/><p>This is a tiny example to show how to deploy the Next.js app on AWS Lambda using <a href="https://up.docs.apex.sh/#introduction">Apex Up</a>.</p><h2>Next.js app with custom server</h2><p>The custom server for Next.js app is needed to run your app on AWS Lambda. In this example, <code>express</code> will be used.</p><pre><code class="hljs language-javascript" metaString=""><span class="hljs-comment">// server.js</span>

<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);
<span class="hljs-keyword">const</span> next = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;next&quot;</span>);

<span class="hljs-keyword">const</span> port = <span class="hljs-built_in">parseInt</span>(process.env.PORT, <span class="hljs-number">10</span>) || <span class="hljs-number">3000</span>;
<span class="hljs-keyword">const</span> dev = process.env.NODE_ENV !== <span class="hljs-string">&quot;production&quot;</span>;
<span class="hljs-keyword">const</span> app = next({ dev });
<span class="hljs-keyword">const</span> handle = app.getRequestHandler();

app
  .prepare()
  .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> server = express();

    server.get(<span class="hljs-string">&quot;/&quot;</span>, (req, res) =&gt; {
      <span class="hljs-keyword">return</span> app.render(req, res, <span class="hljs-string">&quot;/&quot;</span>, req.params);
    });

    server.get(<span class="hljs-string">&quot;/about&quot;</span>, (req, res) =&gt; {
      <span class="hljs-keyword">return</span> app.render(req, res, <span class="hljs-string">&quot;/about&quot;</span>, req.params);
    });

    server.get(<span class="hljs-string">&quot;*&quot;</span>, (req, res) =&gt; {
      <span class="hljs-keyword">return</span> handle(req, res);
    });

    server.listen(port, err =&gt; {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`&gt; Ready on http://localhost:<span class="hljs-subst">${port}</span>`</span>);
    });
  })
  .catch(<span class="hljs-function"><span class="hljs-params">ex</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(ex);
    process.exit(<span class="hljs-number">1</span>);
  });</code></pre><h2>update <code>package.json</code> with custom <code>server.js</code></h2><pre><code class="hljs language-json" metaString="">{
  <span class="hljs-attr">&quot;scripts&quot;</span>: {
    <span class="hljs-attr">&quot;dev&quot;</span>: <span class="hljs-string">&quot;node server.js&quot;</span>,
    <span class="hljs-attr">&quot;build&quot;</span>: <span class="hljs-string">&quot;next build&quot;</span>,
    <span class="hljs-attr">&quot;start&quot;</span>: <span class="hljs-string">&quot;NODE_ENV=production node server.js&quot;</span>
  }
}</code></pre><h2>Install Apex Up</h2><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> curl -sf https://up.apex.sh/install | sh</span>
<span class="hljs-meta">
#</span><span class="bash"> verify the installation</span>
<span class="hljs-meta">$</span><span class="bash"> up version</span></code></pre><h2>AWS credentials</h2><p>You need to have one AWS account and recommend to use IAM with programmaic way for security and convinience. If you have already installed <code>awscli</code> or <code>awsebcli</code>, etc. You are having <code>~/.aws/credentials</code> which is storing AWS credentials. It allows you to use <code>AWS_PROFILE</code> environment. If you don&#x27;t please make one and save it with your account <code>access key</code> and <code>security key</code> in it.</p><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">#</span><span class="bash"> ~/.aws/credentials</span>

[my-aws-account-for-lambda]
aws_access_key = xxxxxxxxxxxxx
aws_secret_access_key = xxxxxxxxxxxxxxxxxxxx</code></pre><h2>IAM policy for Up CLI</h2><p>IAM policy allows the Up to access your AWS resources in order to deploy your Next.js app on Lambda. Go to <a href="https://aws.amazon.com/iam/">AWS IAM</a> and make the new policy and link it up to your AWS account.</p><pre><code class="hljs language-json" metaString="">{
  <span class="hljs-attr">&quot;Version&quot;</span>: <span class="hljs-string">&quot;2012-10-17&quot;</span>,
  <span class="hljs-attr">&quot;Statement&quot;</span>: [
    {
      <span class="hljs-attr">&quot;Effect&quot;</span>: <span class="hljs-string">&quot;Allow&quot;</span>,
      <span class="hljs-attr">&quot;Action&quot;</span>: [
        <span class="hljs-string">&quot;acm:*&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:Create*&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:Delete*&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:Describe*&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:ExecuteChangeSet&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:Update*&quot;</span>,
        <span class="hljs-string">&quot;cloudfront:*&quot;</span>,
        <span class="hljs-string">&quot;cloudwatch:*&quot;</span>,
        <span class="hljs-string">&quot;ec2:*&quot;</span>,
        <span class="hljs-string">&quot;ecs:*&quot;</span>,
        <span class="hljs-string">&quot;events:*&quot;</span>,
        <span class="hljs-string">&quot;iam:AttachRolePolicy&quot;</span>,
        <span class="hljs-string">&quot;iam:CreatePolicy&quot;</span>,
        <span class="hljs-string">&quot;iam:CreateRole&quot;</span>,
        <span class="hljs-string">&quot;iam:DeleteRole&quot;</span>,
        <span class="hljs-string">&quot;iam:DeleteRolePolicy&quot;</span>,
        <span class="hljs-string">&quot;iam:GetRole&quot;</span>,
        <span class="hljs-string">&quot;iam:PassRole&quot;</span>,
        <span class="hljs-string">&quot;iam:PutRolePolicy&quot;</span>,
        <span class="hljs-string">&quot;lambda:AddPermission&quot;</span>,
        <span class="hljs-string">&quot;lambda:Create*&quot;</span>,
        <span class="hljs-string">&quot;lambda:Delete*&quot;</span>,
        <span class="hljs-string">&quot;lambda:Get*&quot;</span>,
        <span class="hljs-string">&quot;lambda:InvokeFunction&quot;</span>,
        <span class="hljs-string">&quot;lambda:List*&quot;</span>,
        <span class="hljs-string">&quot;lambda:RemovePermission&quot;</span>,
        <span class="hljs-string">&quot;lambda:Update*&quot;</span>,
        <span class="hljs-string">&quot;logs:Create*&quot;</span>,
        <span class="hljs-string">&quot;logs:Describe*&quot;</span>,
        <span class="hljs-string">&quot;logs:FilterLogEvents&quot;</span>,
        <span class="hljs-string">&quot;logs:Put*&quot;</span>,
        <span class="hljs-string">&quot;logs:Test*&quot;</span>,
        <span class="hljs-string">&quot;route53:*&quot;</span>,
        <span class="hljs-string">&quot;route53domains:*&quot;</span>,
        <span class="hljs-string">&quot;s3:*&quot;</span>,
        <span class="hljs-string">&quot;ssm:*&quot;</span>,
        <span class="hljs-string">&quot;sns:*&quot;</span>
      ],
      <span class="hljs-attr">&quot;Resource&quot;</span>: <span class="hljs-string">&quot;*&quot;</span>
    },
    {
      <span class="hljs-attr">&quot;Effect&quot;</span>: <span class="hljs-string">&quot;Allow&quot;</span>,
      <span class="hljs-attr">&quot;Action&quot;</span>: <span class="hljs-string">&quot;apigateway:*&quot;</span>,
      <span class="hljs-attr">&quot;Resource&quot;</span>: <span class="hljs-string">&quot;arn:aws:apigateway:*::/*&quot;</span>
    }
  ]
}</code></pre><h2>Create <code>up.json</code> file</h2><pre><code class="hljs language-json" metaString="">{
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;nextjs-example&quot;</span>,
  # aws account profile in ~/.aws/credentials
  <span class="hljs-attr">&quot;profile&quot;</span>: <span class="hljs-string">&quot;my-aws-account-for-lambda&quot;</span>,
  <span class="hljs-attr">&quot;regions&quot;</span>: [<span class="hljs-string">&quot;ap-northeast-2&quot;</span>],
  <span class="hljs-attr">&quot;lambda&quot;</span>: {
    # min 128, default 512
    <span class="hljs-attr">&quot;memory&quot;</span>: <span class="hljs-number">256</span>,
    # AWS Lambda supports node.js 8.10 latest
    <span class="hljs-attr">&quot;runtime&quot;</span>: <span class="hljs-string">&quot;nodejs8.10&quot;</span>
  },
  <span class="hljs-attr">&quot;proxy&quot;</span>: {
    <span class="hljs-attr">&quot;command&quot;</span>: <span class="hljs-string">&quot;npm start&quot;</span>,
    <span class="hljs-attr">&quot;timeout&quot;</span>: <span class="hljs-number">25</span>,
    <span class="hljs-attr">&quot;listen_timeout&quot;</span>: <span class="hljs-number">15</span>,
    <span class="hljs-attr">&quot;shutdown_timeout&quot;</span>: <span class="hljs-number">15</span>
  },
  <span class="hljs-attr">&quot;stages&quot;</span>: {
    <span class="hljs-attr">&quot;development&quot;</span>: {
      <span class="hljs-attr">&quot;proxy&quot;</span>: {
        <span class="hljs-attr">&quot;command&quot;</span>: <span class="hljs-string">&quot;yarn dev&quot;</span>
      }
    }
  },
  <span class="hljs-attr">&quot;environment&quot;</span>: {
    # you can hydrate env variables as you want.
    <span class="hljs-attr">&quot;NODE_ENV&quot;</span>: <span class="hljs-string">&quot;production&quot;</span>
  },
  <span class="hljs-attr">&quot;error_pages&quot;</span>: {
    <span class="hljs-attr">&quot;variables&quot;</span>: {
      <span class="hljs-attr">&quot;support_email&quot;</span>: <span class="hljs-string">&quot;admin@my-email.com&quot;</span>,
      <span class="hljs-attr">&quot;color&quot;</span>: <span class="hljs-string">&quot;#2986e2&quot;</span>
    }
  }
}</code></pre><h2>Build the Next.js app before deploy</h2><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> yarn build</span></code></pre><h2>Create <code>.upignore</code> file</h2><p>The Up will inspect your files to compose and deploy to lambda. Firstly The up will read <code>.gitignore</code> and ignore files written in <code>.gitignore</code>. And after that, <code>.upignore</code> will be read. The Up, by default, ignores dotfiles, so needs to negate <code>.next</code> directory in <code>.upignore</code> in order for the Up will build the package with it.</p><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">#</span><span class="bash"> .upignore</span>

!.next</code></pre><h2>Deploy</h2><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> up</span></code></pre></div></div><div class="post-card"><div><h1>Deploy the Prisma Server to the AWS EC2 with Docker</h1><p>by moondaddi on 2018-12-24</p><hr/><h2>Prisma?</h2><p>Simply, the <a href="https://www.prisma.io/">Prisma</a> is the new ORM(<a href="https://en.wikipedia.org/wiki/Object-relational_mapping">Object Relational Mapping</a>) based on GraphQL query language. The Prisma can make your whole workflow to set up the graphQL API a lot easier. All you need is only graphQL schema in order to set up the graphQL API.</p><blockquote><p>ex. GraphQL schema</p></blockquote><pre><code class="hljs language-graphql" metaString=""><span class="hljs-selector-tag">type</span> <span class="hljs-selector-tag">Tweet</span> {
  <span class="hljs-attribute">id</span>: ID! <span class="hljs-variable">@unique</span>
  <span class="hljs-attribute">createdAt</span>: DateTime!
  <span class="hljs-attribute">text</span>: String!
  <span class="hljs-attribute">owner</span>: User!
  <span class="hljs-attribute">location</span>: Location!
}

<span class="hljs-selector-tag">type</span> <span class="hljs-selector-tag">User</span> {
  <span class="hljs-attribute">id</span>: ID! <span class="hljs-variable">@unique</span>
  <span class="hljs-attribute">createdAt</span>: DateTime!
  <span class="hljs-attribute">updatedAt</span>: DateTime!
  <span class="hljs-attribute">handle</span>: String! <span class="hljs-variable">@unique</span>
  <span class="hljs-attribute">name</span>: String
  <span class="hljs-attribute">tweets</span>: [Tweet!]!
}

<span class="hljs-selector-tag">type</span> <span class="hljs-selector-tag">Location</span> {
  <span class="hljs-attribute">latitude</span>: Float!
  <span class="hljs-attribute">longitude</span>: Float!
}</code></pre><p>If you make your graphQL schema to <code>datamodel.prisma</code> file. It&#x27;s all set. Prisma will deploy your schema to the connected DB(Prisma Cloud or your Remote DB/Local DB) and generate all kind of graphQL schema (types and resolvers) for you automatically. Fantastic, isn&#x27;t it?</p><h2>Structure</h2><p><img src="/static/images/post_img/prisma_structure.jpg" alt="Prisma structure"/></p><blockquote><p>GraphQL API Server = GraphQL API + Prisma Server</p></blockquote><p>Prisma API Server consists of two parts, <code>GraphQL API</code> + <code>Prisma Server</code>. GraphQL API is the backend layer which contains your business logic, such as querying users, sign up, log in, locations, and so on. You can set it up with Express or GraphQL Yoga, etc. Otherwise, Prisma Server means the backend server which contains all the graphQL schema as per your data model and is connected to database. Prisma suggests the Docker in order to set up Prisma Server.</p><p>This post will explain how to deploy this Prisma Server to AWS ECS and ECR service.</p><h2>Deploy the Prisma Server</h2><h2>Requirements</h2><ul><li><p>Docker</p><blockquote><p>(for mac) <a href="https://hub.docker.com/editions/community/docker-ce-desktop-mac">https://hub.docker.com/editions/community/docker-ce-desktop-mac</a></p></blockquote></li><li><p>Prisma Cli</p></li></ul><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> npm i -g prisma</span>
<span class="hljs-meta">#</span><span class="bash"> or</span>
<span class="hljs-meta">$</span><span class="bash"> yarn global add prisma</span></code></pre><h2>(Option 1) Using Docker machine</h2><p>This is using docker-machine in cli. The docker-machine will create a docker machine on AWS EC2 directly. and docker-compose will compose the prisma server along with <code>docker-compse.yml</code> in docker-machine.</p><h3>Create the docker machine on AWS EC2</h3><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> docker-machine create --driver amazonec2 --amazonec2-region ap-northeast-2 --amazonec2-vpc-id __SPECIFIC_VPC__ prisma-server-example</span></code></pre><ul><li>If creating EC2 instance is failed, check your AWS credentials and IAM policy.</li></ul><h3>Activate new machine as active host</h3><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> docker-machine prisma-server-example</span>
<span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">eval</span> $(docker-machine env prisma-server-example)</span>
<span class="hljs-meta">
#</span><span class="bash"> check docker-machine</span>
<span class="hljs-meta">$</span><span class="bash"> docker-machine ls</span></code></pre><h3><code>docker-compose.yml</code> file</h3><pre><code class="hljs language-yml" metaString=""><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span>
<span class="hljs-attr">services:</span>
<span class="hljs-attr">  prisma:</span>
<span class="hljs-attr">    image:</span> <span class="hljs-string">prismagraphql/prisma:1.23</span>
<span class="hljs-attr">    restart:</span> <span class="hljs-string">always</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">      -</span> <span class="hljs-string">&quot;4466:4466&quot;</span>
    <span class="hljs-comment"># logging available in AWS CloudWatch</span>
<span class="hljs-attr">    logging:</span>
<span class="hljs-attr">      driver:</span> <span class="hljs-string">awslogs</span>
<span class="hljs-attr">      options:</span>
<span class="hljs-attr">        awslogs-group:</span> <span class="hljs-string">__AWSLOG_GROUP__</span>
<span class="hljs-attr">        awslogs-region:</span> <span class="hljs-string">ap-northeast-2</span>
<span class="hljs-attr">        awslogs-stream-prefix:</span> <span class="hljs-string">__AWSLOG_STREAM_PREFIX__</span>
<span class="hljs-attr">    environment:</span>
<span class="hljs-attr">      PRISMA_CONFIG:</span> <span class="hljs-string">|
</span><span class="hljs-attr">        port:</span> <span class="hljs-number">4466</span>
        <span class="hljs-comment"># managementApiSecret: __SECRET_KEY__</span>
<span class="hljs-attr">        databases:</span>
<span class="hljs-attr">          default:</span>
<span class="hljs-attr">            connector:</span> <span class="hljs-string">postgres</span> <span class="hljs-comment"># PostgreSQL</span>
<span class="hljs-attr">            host:</span> <span class="hljs-string">__AWS_RDS_HOST__</span>
<span class="hljs-attr">            database:</span> <span class="hljs-string">__DB_NAME__</span>
<span class="hljs-attr">            schema:</span> <span class="hljs-string">__DB_SCHEMA__</span>
<span class="hljs-attr">            user:</span> <span class="hljs-string">__DB_USERNAME__</span>
<span class="hljs-attr">            password:</span> <span class="hljs-string">__DB_PASSWORD__</span>
<span class="hljs-attr">            rawAccess:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">            port:</span> <span class="hljs-number">5432</span>
<span class="hljs-attr">            migrations:</span> <span class="hljs-literal">false</span></code></pre><h3>Compose Prisma Server in new docker machine</h3><pre><code class="hljs language-shell" metaString="">docker compose up -d</code></pre><h3>Assign security group and check inbound rules</h3><ul><li>Basically, EC2 is assigned new security group as defalut. You need to check its inbound rule and open 4466 port.</li></ul><h3>Set the elastic load balancer (optional)</h3><h3>Modify prisma.yml</h3><pre><code class="hljs language-yml" metaString=""><span class="hljs-attr">endpoint:</span> <span class="hljs-attr">http://__AWS_EC2_ADDRESS__:4466</span>
<span class="hljs-attr">datamodel:</span> <span class="hljs-string">datamodel.prisma</span>

<span class="hljs-attr">generate:</span>
<span class="hljs-attr">  - generator:</span> <span class="hljs-string">javascript-client</span>
<span class="hljs-attr">    output:</span> <span class="hljs-string">./generated/prisma-client/</span></code></pre><h3>Deploy datamodel.prisma to Prisma Server in AWS EC2</h3><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> PRISMA_MANAGEMENT_API_SECRET=__SECRET_KEY__ prisma deploy</span></code></pre><h3>Generate prisma client for GraphQL API</h3><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> prisma generate</span></code></pre><p>References</p><blockquote><p><a href="https://docs.docker.com/machine/drivers/aws/">https://docs.docker.com/machine/drivers/aws/</a> <a href="https://docs.docker.com/machine/examples/aws/#step-2-use-machine-to-create-the-instance">https://docs.docker.com/machine/examples/aws/#step-2-use-machine-to-create-the-instance</a></p></blockquote><hr/><h2>(Option 2) Using AWS ECS Cli</h2><h3>Create EC2 and ECS cluster</h3><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> ecs-cli up --keypair __AWS_KEYPAIR_NAME__ --capability-iam --vpc __SPECIFIC_VPC__ --subnets __SUBNET_1__,__SUBNET_2__ --size 1 --instance-type t2.micro --cluster-config prisma-server-ecs</span></code></pre><ul><li>It will generate the cloudformation which will proceed the whole process to generate EC2 instance and ECS cluster.</li></ul><h3>Compose the Prisma Server to ECS container</h3><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> ecs-cli compose up --create-log-groups --cluster-config prisma-server-ecs</span></code></pre><ul><li>It will generate the new Task definition. You can check the new Task definition is runnig.</li></ul><h3>Check if the new Task definition is running</h3><pre><code class="hljs language-shell" metaString=""><span class="hljs-meta">$</span><span class="bash"> esc-cli ps</span></code></pre><ul><li>If your new Task definition is working well, you might want to make new service in ECS cluster in order to manage the task.</li></ul><p>References</p><blockquote><p><a href="https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/ECR_AWSCLI.html">https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/ECR_AWSCLI.html</a> &gt; <a href="https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/developerguide/ECS_CLI_tutorial_EC2.html">https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/developerguide/ECS_CLI_tutorial_EC2.html</a></p></blockquote></div></div><div class="post-card"><div><h1>AWS Elastic Beanstalk makes redirect to HTTPS</h1><p>by moondaddi on 2018-12-18</p><hr/><h2>Elastic Load balancer and Elastic Beanstalk</h2><p>AWS Elastic Load balancer automatically distributes incoming application traffic across multiple AWS EC2. It enables your application&#x27;s falut tolerance level higher and seamlessly providing the required amount of load balancing capacity needed to distribute application traffics.</p><p>When you deploy your application whatever it&#x27;s built with any language to Elastic Beanstalk, Elastic Beanstalk automatically performs all required process in deployment for your application. One of requirements is Elastic Load balancer in front of EC2 which is generated by Elastic Beanstalk.</p><p>Elastic Load balancer is listening the port 80 as default. And you can set 443 port for HTTPS.</p><h2>Redirect to HTTPS</h2><p>Once everything sets up, You can access your application in Elastic Beanstalk through HTTP and also HTTPS.</p><p>If you want all requests to port 80 to redirect to port 443, HTTPS, you can make ssl_redirect.config file in .ebextensions in your application root directory.</p><pre><code class="hljs language-apache" metaString=""><span class="hljs-attribute">files</span>:
    &quot;/<span class="hljs-attribute">etc</span>/httpd/conf.d/ssl_redirect.conf<span class="hljs-string">&quot;:
        mode: &quot;</span>000644<span class="hljs-string">&quot;
        owner: root
        group: root
        content: |
            RewriteEngine On
            &lt;If &quot;</span>-n &#x27;<span class="hljs-variable">%{HTTP:X-Forwarded-Proto}</span>&#x27; &amp;&amp; <span class="hljs-variable">%{HTTP:X-Forwarded-Proto}</span> != &#x27;https&#x27;<span class="hljs-string">&quot;&gt;
            RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R,L]
            &lt;/If&gt;</span></code></pre><h2>How it works</h2><p>During deployment of Elastic Beanstalk, it will check <code>.ebextendsion</code> directory if any <code>*.config</code> files there. If config file is found, Elastic Beanstalk will proceed it before applying the deployment of your application.</p><p><code>ssl_redirect.config</code> file will be generated in path <code>/etc/httpd/conf.d/</code> and this will works for apache server to check any none https request and redirect it to https.</p></div></div></div><div><h2 class="index-h2-title pinned">Pinned Posts <i id="pinned" class="fas fa-thumbtack"></i></h2><div class="post">...</div></div></div></div><style jsx="true">
.index-h2-title {
  display: inline-block;
  border: 5px solid #2c3e50;
  border-radius: 35px;
  padding: 10px 20px;
  background-color: #fff;
}
.pinned {
  border: 5px solid #e74c3c;
}
#latest {
  color: #f39c12;
}
#pinned {
  color: #e74c3c;
}

.post-card {
  background-color: #fff;
  border: 1px solid #eee;
  padding: 20px;
  margin-bottom: 50px;
  border-radius: 5px;
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
}

blockquote {
  margin: 0;
  padding: 0 1em;
  color: #6a737d;
  border-left: 0.25em solid #dfe2e5;
}

code {
  color: #c0392b;
  padding: 2px 3px;
  border: 1px solid #ccc;
  border-radius: 3px;
}

pre code {
  overflow: auto;
  word-wrap: normal;
  white-space: pre;
  // width: calc(100vw - 360px);
}

/* a11y-dark theme */
/* Based on the Tomorrow Night Eighties theme: https://github.com/isagalaev/highlight.js/blob/master/src/styles/tomorrow-night-eighties.css */
/* @author: ericwbailey */

/* Comment */
.hljs-comment,
.hljs-quote {
  color: #d4d0ab;
}

/* Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
  color: #ffa07a;
}

/* Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
  color: #f5ab35;
}

/* Yellow */
.hljs-attribute {
  color: #ffd700;
}

/* Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
  color: #abe338;
}

/* Blue */
.hljs-title,
.hljs-section {
  color: #00e0e0;
}

/* Purple */
.hljs-keyword,
.hljs-selector-tag {
  color: #dcc6e0;
}

.hljs {
  display: block;
  overflow-x: auto;
  background: #2b2b2b;
  color: #f8f8f2;
  padding: 1rem;
  font-size: 1rem;
  border-radius: 5px;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

@media screen and (-ms-high-contrast: active) {
  .hljs-addition,
  .hljs-attribute,
  .hljs-built_in,
  .hljs-builtin-name,
  .hljs-bullet,
  .hljs-comment,
  .hljs-link,
  .hljs-literal,
  .hljs-meta,
  .hljs-number,
  .hljs-params,
  .hljs-string,
  .hljs-symbol,
  .hljs-type,
  .hljs-quote {
        color: highlight;
    }

    .hljs-keyword,
    .hljs-selector-tag {
        font-weight: bold;
    }
}

@media (max-width: 576px) {
  pre {
    width: calc(100vw - 60px);
  }
}
</style><div id="footer"><div class="footer-container"><div class="footer-left-span"></div><div class="copyright"><div>Copyright © 2018 Moondaddi&#x27;s Blog</div><div>The source code is under MIT License</div></div><div class="footer-right-span"><a href="mailto:woonki.moon@gmail.com"><i class="fas fa-envelope"></i></a><a href="https://github.com/mattdamon108" target="_blank"><i class="fab fa-github"></i></a></div></div></div><style jsx="true">
      .footer-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .footer-left-span {
        width: 70px;
      }
      .copyright {
        color: #999;
        font-size: 0.8rem;
        text-align: center;
        padding: 10px;
      }
      .footer-right-span {
        color: #fff;
        font-size: 1.5rem;
        text-align: right;
      }
      .footer-right-span a:link,
      .footer-right-span a:visited,
      .footer-right-span a:hover,
      .footer-right-span a:active {
        color: #fff;
      }
      .footer-right-span i {
        padding-right: 10px;
      }
    </style></div></div><div id="__next-error"></div><script>
          __NEXT_DATA__ = {"props":{"pageProps":{}},"page":"/","pathname":"/","query":{},"buildId":"b071a135-2bb6-4443-8de0-74c936e64935","assetPrefix":"","nextExport":true,"err":null,"chunks":[]}
          module={}
          __NEXT_LOADED_PAGES__ = []
          __NEXT_LOADED_CHUNKS__ = []

          __NEXT_REGISTER_PAGE = function (route, fn) {
            __NEXT_LOADED_PAGES__.push({ route: route, fn: fn })
          }

          __NEXT_REGISTER_CHUNK = function (chunkName, fn) {
            __NEXT_LOADED_CHUNKS__.push({ chunkName: chunkName, fn: fn })
          }

          false
        </script><script async="" id="__NEXT_PAGE__/" src="/_next/b071a135-2bb6-4443-8de0-74c936e64935/page/index.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/b071a135-2bb6-4443-8de0-74c936e64935/page/_app.js"></script><script async="" id="__NEXT_PAGE__/_error" src="/_next/b071a135-2bb6-4443-8de0-74c936e64935/page/_error.js"></script><script src="/_next/static/commons/main-c5f62fe11b39d6908ec5.js" async=""></script></body></html>