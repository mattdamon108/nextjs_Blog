<!DOCTYPE html><html lang="en"><head><meta name="author" content="moondaddi"/><link rel="manifest" href="/static/manifest.json"/><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Merriweather" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Build my dreams with codes"/><meta name="theme-color" content="#222f3e"/><meta charSet="utf-8" class="next-head"/><title class="jsx-1456713024 next-head">Build the Codes</title><link rel="preload" href="/_next/static/d4rp~rf2cJU~qMae2CxbJ/pages/post.js" as="script"/><link rel="preload" href="/_next/static/d4rp~rf2cJU~qMae2CxbJ/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-838b392324e3598684b5.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.c6d8074ce2c43a1f4920.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-97da79c9c9960a7c6dea.js" as="script"/><style id="__jsx-1365585798">#header.jsx-1365585798{background-color:var(--background-color);color:white;}.header-container.jsx-1365585798{margin:0 1rem;padding:1rem 0;}#header-title.jsx-1365585798{display:block;position:relative;font-family:var(--text-san-serif);font-size:1.7rem;margin:1rem auto;font-weight:bold;}#header-title.jsx-1365585798 a.jsx-1365585798{color:white;-webkit-text-decoration:none;text-decoration:none;}#avatar-img.jsx-1365585798{display:inline-block;-webkit-border-radius:25px;-moz-border-radius:25px;border-radius:25px;width:50px;height:50px;background-size:contain;background-repeat:no-repeat;background-position:center center;vertical-align:middle;}#profile.jsx-1365585798{display:inline-block;vertical-align:middle;padding-left:1rem;font-family:$font-serif;color:$text-normal-color;font-size:0.9rem;}#header-body.jsx-1365585798{position:relative;}#menu.jsx-1365585798{display:inline-block;position:absolute;right:0;font-family:$font-serif;font-size:0.9rem;margin-top:1rem;}#menu.jsx-1365585798 #header-tag.jsx-1365585798{display:inline-block;margin:auto 1rem;}#menu.jsx-1365585798 #header-about.jsx-1365585798{display:inline-block;margin:auto 1rem;}@media (max-width:576px){#menu.jsx-1365585798{display:block;text-align:right;position:relative;}}</style><style id="__jsx-2496144457">.post-container.jsx-2496144457{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:1rem;}.post-img-container.jsx-2496144457{min-width:150px;height:150px;background-size:cover;background-repeat:no-repeat;background-position:center;}.post-body.jsx-2496144457{display:inline-block;margin:0 1rem;}.post-title.jsx-2496144457{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial, sans-serif;font-size:1.5rem;font-weight:700;margin:1rem 0 0.5rem 0;}.post-subtitle.jsx-2496144457{color:grey;}.post-createdAt.jsx-2496144457{margin:1rem 0 0 0;}@media (max-width:576px){.post-container.jsx-2496144457{display:block;margin:1rem;}}</style><style id="__jsx-3376242649">#footer.jsx-3376242649{background-color:var(--background-color);}.footer-container.jsx-3376242649{height:5rem;font-family:$font-serif;font-size:0.9rem;}#footer-github.jsx-3376242649{padding-top:2rem;}</style><style id="__jsx-1456713024">html,body{width:100%;margin:0;padding:0;border:0;--background-color:#222f3e;--text-serif:Merriweather,Courier,serif;--text-san-serif:"Ubuntu","Helvetica Neue",Helvetica,Arial, sans-serif;--text-link-color:#ed4c67;}body{font-size:1rem;font-family:var(--text-serif);font-weight:300;width:100%;line-height:200%;-webkit-font-smoothing:antialiased;}a{-webkit-text-decoration:underline;text-decoration:underline;}a:link{color:var(--text-link-color);}a:visited{color:var(--text-link-color);}a:hover{color:var(--text-link-color);}a:active{color:var(--text-link-color);}.container{width:800px;margin:0 auto;}@media (max-width:900px){.container{width:100%;margin:0 auto;}}.post-content{background-color:#fff;padding:1rem;margin-bottom:50px;}img{width:100%;max-width:-webkit-fit-content;max-width:-moz-fit-content;max-width:fit-content;}blockquote{margin:0;padding:0 1em;color:#6a737d;border-left:0.25em solid #dfe2e5;word-break:break-word;}code{padding:2px 3px;border-width:0;border-radius:3px;background-color:rgba(255,229,100,0.2);font-family:Merriweather,Courier,serif;}pre code{overflow:auto;word-wrap:normal;white-space:pre;line-height:150%;}.hljs-comment,.hljs-quote{color:#d4d0ab;}.hljs-variable,.hljs-template-variable,.hljs-tag,.hljs-name,.hljs-selector-id,.hljs-selector-class,.hljs-regexp,.hljs-deletion{color:#ffa07a;}.hljs-number,.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-type,.hljs-params,.hljs-meta,.hljs-link{color:#f5ab35;}.hljs-attribute{color:#ffd700;}.hljs-string,.hljs-symbol,.hljs-bullet,.hljs-addition{color:#abe338;}.hljs-title,.hljs-section{color:#00e0e0;}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0;}.hljs{display:block;overflow-x:auto;background:#2b2b2b;color:#f8f8f2;padding:1rem;font-family:Consolas,Menlo,Monaco,monospace;font-size:0.8rem;font-weight:600;border-radius:5px;}.hljs-emphasis{font-style:italic;}.hljs-strong{font-weight:bold;}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-string,.hljs-symbol,.hljs-type,.hljs-quote{color:highlight;}.hljs-keyword,.hljs-selector-tag{font-weight:bold;}}@media (max-width:576px){pre{width:100%;}}</style><style id="__jsx-411869389">#header.jsx-411869389{background-color:var(--background-color);color:white;}.header-container.jsx-411869389{position:relative;margin:0 1rem;}#header-title.jsx-411869389{display:inline-block;font-family:var(--text-san-serif);font-size:1.4rem;margin:1rem auto;font-weight:bold;}#header-title.jsx-411869389 a.jsx-411869389{color:white;-webkit-text-decoration:none;text-decoration:none;}#header-body.jsx-411869389{display:inline-block;position:absolute;right:0;margin:1rem auto;text-align:right;}#menu.jsx-411869389{display:inline-block;font-size:0.9rem;}#menu.jsx-411869389 #header-tag.jsx-411869389{display:inline-block;margin:auto 1rem;}#menu.jsx-411869389 #header-about.jsx-411869389{display:inline-block;margin:auto 1rem;}@media (max-width:576px){#header-title.jsx-411869389{margin:1rem auto 0 auto;}#header-body.jsx-411869389{display:block;text-align:right;position:relative;margin:0 auto;}}</style></head><body><div id="__next"><div id="header" class="jsx-411869389"><div class="jsx-411869389 container"><div class="jsx-411869389 header-container"><div id="header-title" class="jsx-411869389"><a href="/" class="jsx-411869389">Build the Codes</a></div><div id="header-body" class="jsx-411869389"><div id="menu" class="jsx-411869389"><div id="header-tag" class="jsx-411869389"><a href="/tag" class="jsx-411869389">Tags</a></div><div id="header-about" class="jsx-411869389"><a href="/about" class="jsx-411869389">About</a></div></div></div></div></div></div><div id="content"><div class="container"><div class="post-content"><div><h1>File upload with GraphQL Apollo client &amp; Django + Graphene</h1><p>by moondaddi on 2018-08-28</p><hr/><h2>Requirements</h2><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> pip install django</span>
<span class="hljs-meta">$</span><span class="bash"> pip install graphene_django</span>
<span class="hljs-meta">$</span><span class="bash"> pip install graphene-file-upload</span>
<span class="hljs-meta">$</span><span class="bash"> pip install python-resize-image</span></code></pre><ul><li>Django==2.0.7</li><li>graphene==2.1.2</li><li>graphene-django==2.0.0</li><li>graphene-file-upload==1.0.0</li><li>graphql-core==2.0</li><li>graphql-relay==0.4.5</li><li>python-resize-image==1.1.11</li></ul><br/><h2>Backend</h2><blockquote><p>Mutation part</p></blockquote><pre><code class="hljs language-python"><span class="hljs-keyword">import</span> graphene
<span class="hljs-keyword">from</span> graphene_django <span class="hljs-keyword">import</span> DjangoObjectType
<span class="hljs-keyword">from</span> graphene_file_upload.scalars <span class="hljs-keyword">import</span> Upload

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CUDNewsBoard</span><span class="hljs-params">(graphene.Mutation)</span>:</span>
  newsboard = graphene.Field(NewsBoardType)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Arguments</span>:</span> <span class="hljs-comment"># other arguments up here...</span>
  files = Upload()

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mutate</span><span class="hljs-params">(self, info, files=None, ...)</span>:</span>
    user = info.context.user

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user.is_staff:
      <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Admin permission is required!&#x27;</span>)

    post = NewsBoard(user=user, title=title, content=content)
    post.save()

    <span class="hljs-keyword">if</span> files:
      <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:

        postimage = NewsBoardImage(post=post, image=<span class="hljs-keyword">None</span>)
        postimage.save()

        image_obj = Image.open(file)
        <span class="hljs-comment"># resize image</span>
        image_obj = resizeimage.resize_width(image_obj, <span class="hljs-number">800</span>, validate=<span class="hljs-keyword">False</span>)

        new_image_io = BytesIO()
        image_obj.save(new_image_io, image_obj.format)

        temp_name = file.name

        postimage.image.save(
          temp_name,
          content=ContentFile(new_image_io.getvalue())
        )

    <span class="hljs-keyword">return</span> CUDNewsBoard(newsboard=post)</code></pre><br/><h2>Frontend</h2><pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> NEW_POST_NEWS = gql<span class="hljs-string">`
mutation postNew($files: Upload, ...) {
  cudNewsboard(files: $files, ...) {
    newsboard {
      id
      user {
        id
        fullname
      }
      title
      content
      firstDate
      views
      likes {
        id
      }
      newsboardimages {
        id
        image
      }
    }
  }
}
`</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BoardNewsInput</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> </span>{
  state = {
    <span class="hljs-attr">images</span>: []
  };

  render() {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        </span>&lt;input
          type=&quot;file&quot;
          name=&quot;image&quot;
          onChange={({
            target: {
              validity,
              files: [file]
            }
          }) =&gt;
            validity.valid &amp;&amp;
            this.setState({
              images: [...this.state.images, file]
            })
          }
        /&gt;
        &lt;Mutation
          mutation={NEW_POST_NEWS}
          variables={{
            files: this.state.images ? this.state.images : null
          }}
        &gt;
          {(cudNewsboard, { loading, error, data }) =&gt; (
            &lt;button
              onClick={() =&gt; {
                cudNewsboard();
              }}
            &gt;
              POST
            &lt;/button&gt;
          )}
        &lt;/Mutation&gt;
      &lt;/div&gt;<span class="xml">
    );
  }
}</span></code></pre><br/><h2>Lesson &amp; Learn</h2><ol><li>Array can be substitutive for FileList object in this case.</li></ol><pre><code class="hljs language-javascript">state = {
  <span class="hljs-attr">images</span>: [file, file, file, ...]
}</code></pre><br/><ol start="2"><li>Input onChange method</li></ol><pre><code class="hljs language-javascript">&lt;input
  onChange={({ validity, <span class="hljs-attr">files</span>: [file] }) =&gt;
    validity.valid &amp;&amp;
    <span class="hljs-keyword">this</span>.setState(<span class="hljs-function"><span class="hljs-params">prevState</span> =&gt;</span> {
      <span class="hljs-attr">images</span>: [...prevState.images, file];
    })
  }
/&gt;</code></pre><br/><h2>References</h2></div></div></div></div><div id="header" class="jsx-1365585798"><div class="jsx-1365585798 container"><div class="jsx-1365585798 header-container"><div id="header-title" class="jsx-1365585798"><a href="/" class="jsx-1365585798">Build the Codes</a></div><div id="header-body" class="jsx-1365585798"><div id="avatar-img" style="background-image:url(&quot;/static/images/avatar/moondaddi_avatar.jpg&quot;)" class="jsx-1365585798"></div><div id="profile" class="jsx-1365585798"><div id="name" class="jsx-1365585798"><a href="/about" class="jsx-1365585798">moondaddi</a></div><div class="jsx-1365585798">My dreams with Codes</div></div><div id="menu" class="jsx-1365585798"><div id="header-tag" class="jsx-1365585798"><a href="/tag" class="jsx-1365585798">Tags</a></div><div id="header-about" class="jsx-1365585798"><a href="/about" class="jsx-1365585798">About</a></div></div></div></div></div></div><div id="footer" class="jsx-3376242649"><div class="jsx-3376242649 container"><div class="jsx-3376242649 footer-container"><div id="footer-github" class="jsx-3376242649"><a href="https://github.com/mattdamon108" target="_blank" class="jsx-3376242649">Github</a></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post","query":{"filename":"2018-08-28-File-upload-with-GraphQL-Apollo-Client-Django-Graphene"},"buildId":"d4rp~rf2cJU~qMae2CxbJ","nextExport":true}</script><script async="" id="__NEXT_PAGE__/post" src="/_next/static/d4rp~rf2cJU~qMae2CxbJ/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/d4rp~rf2cJU~qMae2CxbJ/pages/_app.js"></script><script src="/_next/static/runtime/webpack-838b392324e3598684b5.js" async=""></script><script src="/_next/static/chunks/commons.c6d8074ce2c43a1f4920.js" async=""></script><script src="/_next/static/runtime/main-97da79c9c9960a7c6dea.js" async=""></script></body></html>