<!DOCTYPE html><html lang="en"><head><meta name="author" content="Moondaddi"/><link rel="manifest" href="/static/manifest.json"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Build my dreams with codes"/><meta name="theme-color" content="black"/><meta charSet="utf-8" class="next-head"/><title class="next-head">Moondaddi&#x27;s Blog</title><link rel="preload" href="/_next/static/DmTcGCUL9fzETrbP8ToCP/pages/post.js" as="script"/><link rel="preload" href="/_next/static/DmTcGCUL9fzETrbP8ToCP/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-f0c6edbea5b547edc23f.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.298c115416bea8464748.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-ea256225ecf9df19827a.js" as="script"/><style id="__jsx-1792980523">.footer-container.jsx-1792980523{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.footer-left-span.jsx-1792980523{width:70px;}.copyright.jsx-1792980523{color:#999;font-size:0.8rem;text-align:center;padding:10px;}.footer-right-span.jsx-1792980523{color:#fff;font-size:1.5rem;text-align:right;}.footer-right-span.jsx-1792980523 a.jsx-1792980523:link,.footer-right-span.jsx-1792980523 a.jsx-1792980523:visited,.footer-right-span.jsx-1792980523 a.jsx-1792980523:hover,.footer-right-span.jsx-1792980523 a.jsx-1792980523:active{color:#fff;}.footer-right-span.jsx-1792980523 i.jsx-1792980523{padding-right:10px;}</style></head><body><div id="__next"><div id="layout"><div id="header" class="jsx-undefined"><div id="header-top" class="jsx-undefined"><div id="home" class="jsx-undefined"><div id="home-title" class="jsx-undefined"><a class="jsx-undefined" href="/">Build my Dreams with Codes</a></div><div id="home-title-sm" class="jsx-undefined"><a class="jsx-undefined" href="/">BDC</a></div></div><div id="menu" class="jsx-undefined"><a id="menu-about" class="jsx-undefined" href="/about/">About</a><i id="search-button-sm" class="jsx-undefined fa fa-search"></i><div id="search-container-id" class="jsx-undefined search-container"><span class="jsx-undefined icon"><i class="jsx-undefined fa fa-search"></i></span><input type="text" id="search" value="" class="jsx-undefined"/></div><div id="menu-button" class="jsx-undefined"><i class="jsx-undefined fas fa-bars"></i></div></div></div></div><div id="category" class="jsx-undefined"><div id="container-category" class="jsx-undefined"><div id="container-category-fixed" class="jsx-undefined"><div id="menu-close-button" class="jsx-undefined"><i class="jsx-undefined fas fa-times"></i></div><a class="jsx-undefined" href="/post/react/"><span class="jsx-undefined">React</span><span class="jsx-undefined">4</span></a><a class="jsx-undefined" href="/post/django/"><span class="jsx-undefined">Django</span><span class="jsx-undefined">3</span></a><a class="jsx-undefined" href="/post/javascript/"><span class="jsx-undefined">Javascript</span><span class="jsx-undefined">0</span></a><a class="jsx-undefined" href="/post/python/"><span class="jsx-undefined">Python</span><span class="jsx-undefined">0</span></a><a class="jsx-undefined" href="/post/htmlcss/"><span class="jsx-undefined">Html CSS</span><span class="jsx-undefined">1</span></a><a id="selected" class="jsx-undefined" href="/post/backend/"><span class="jsx-undefined">Backend</span><span class="jsx-undefined">3</span></a><a class="jsx-undefined" href="/post/devlogs/"><span class="jsx-undefined">dev logs</span><span class="jsx-undefined">5</span></a></div></div></div><div id="content"><div class="container"><div class="post-card"></div><div><h1>Deploy the Prisma Server to the AWS EC2 with Docker</h1><p>by moondaddi on 2018-12-24</p><hr/><h2>Prisma?</h2><p>Simply, the <a href="https://www.prisma.io/">Prisma</a> is the new ORM(<a href="https://en.wikipedia.org/wiki/Object-relational_mapping">Object Relational Mapping</a>) based on GraphQL query language. The Prisma can make your whole workflow to set up the graphQL API a lot easier. All you need is only graphQL schema in order to set up the graphQL API.</p><blockquote><p>ex. GraphQL schema</p></blockquote><pre><code class="hljs language-js">type Tweet {
  <span class="hljs-attr">id</span>: ID! @unique
  createdAt: DateTime!
  text: <span class="hljs-built_in">String</span>!
  owner: User!
  location: Location!
}

type User {
  <span class="hljs-attr">id</span>: ID! @unique
  createdAt: DateTime!
  updatedAt: DateTime!
  handle: <span class="hljs-built_in">String</span>! @unique
  name: <span class="hljs-built_in">String</span>
  tweets: [Tweet!]!
}

type Location {
  <span class="hljs-attr">latitude</span>: Float!
  longitude: Float!
}</code></pre><p>If you make your graphQL schema to <code>datamodel.prisma</code> file. It&#x27;s all set. Prisma will deploy your schema to the connected DB(Prisma Cloud or your Remote DB/Local DB) and generate all kind of graphQL schema (types and resolvers) for you automatically. Fantastic, isn&#x27;t it?</p><h2>Structure</h2><p><img src="/static/images/post_img/prisma_structure.jpg" alt="Prisma structure"/></p><blockquote><p>GraphQL API Server = GraphQL API + Prisma Server</p></blockquote><p>Prisma API Server consists of two parts, <code>GraphQL API</code> + <code>Prisma Server</code>. GraphQL API is the backend layer which contains your business logic, such as querying users, sign up, log in, locations, and so on. You can set it up with Express or GraphQL Yoga, etc. Otherwise, Prisma Server means the backend server which contains all the graphQL schema as per your data model and is connected to database. Prisma suggests the Docker in order to set up Prisma Server.</p><p>This post will explain how to deploy this Prisma Server to AWS ECS and ECR service.</p><h2>Deploy the Prisma Server</h2><h2>Requirements</h2><ul><li><p>Docker</p><blockquote><p>(for mac) <a href="https://hub.docker.com/editions/community/docker-ce-desktop-mac">https://hub.docker.com/editions/community/docker-ce-desktop-mac</a></p></blockquote></li><li><p>Prisma Cli</p></li></ul><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> npm i -g prisma</span>
<span class="hljs-meta">#</span><span class="bash"> or</span>
<span class="hljs-meta">$</span><span class="bash"> yarn global add prisma</span></code></pre><h2>(Option 1) Using Docker machine</h2><p>This is using docker-machine in cli. The docker-machine will create a docker machine on AWS EC2 directly. and docker-compose will compose the prisma server along with <code>docker-compse.yml</code> in docker-machine.</p><h3>Create the docker machine on AWS EC2</h3><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> docker-machine create --driver amazonec2 --amazonec2-region ap-northeast-2 --amazonec2-vpc-id __SPECIFIC_VPC__ prisma-server-example</span></code></pre><ul><li>If creating EC2 instance is failed, check your AWS credentials and IAM policy.</li></ul><h3>Activate new machine as active host</h3><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> docker-machine prisma-server-example</span>
<span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">eval</span> $(docker-machine env prisma-server-example)</span>
<span class="hljs-meta">
#</span><span class="bash"> check docker-machine</span>
<span class="hljs-meta">$</span><span class="bash"> docker-machine ls</span></code></pre><h3><code>docker-compose.yml</code> file</h3><pre><code class="hljs language-yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span>
<span class="hljs-attr">services:</span>
<span class="hljs-attr">  prisma:</span>
<span class="hljs-attr">    image:</span> <span class="hljs-string">prismagraphql/prisma:1.23</span>
<span class="hljs-attr">    restart:</span> <span class="hljs-string">always</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">      -</span> <span class="hljs-string">&quot;4466:4466&quot;</span>
    <span class="hljs-comment"># logging available in AWS CloudWatch</span>
<span class="hljs-attr">    logging:</span>
<span class="hljs-attr">      driver:</span> <span class="hljs-string">awslogs</span>
<span class="hljs-attr">      options:</span>
<span class="hljs-attr">        awslogs-group:</span> <span class="hljs-string">__AWSLOG_GROUP__</span>
<span class="hljs-attr">        awslogs-region:</span> <span class="hljs-string">ap-northeast-2</span>
<span class="hljs-attr">        awslogs-stream-prefix:</span> <span class="hljs-string">__AWSLOG_STREAM_PREFIX__</span>
<span class="hljs-attr">    environment:</span>
<span class="hljs-attr">      PRISMA_CONFIG:</span> <span class="hljs-string">|
</span><span class="hljs-attr">        port:</span> <span class="hljs-number">4466</span>
        <span class="hljs-comment"># managementApiSecret: __SECRET_KEY__</span>
<span class="hljs-attr">        databases:</span>
<span class="hljs-attr">          default:</span>
<span class="hljs-attr">            connector:</span> <span class="hljs-string">postgres</span> <span class="hljs-comment"># PostgreSQL</span>
<span class="hljs-attr">            host:</span> <span class="hljs-string">__AWS_RDS_HOST__</span>
<span class="hljs-attr">            database:</span> <span class="hljs-string">__DB_NAME__</span>
<span class="hljs-attr">            schema:</span> <span class="hljs-string">__DB_SCHEMA__</span>
<span class="hljs-attr">            user:</span> <span class="hljs-string">__DB_USERNAME__</span>
<span class="hljs-attr">            password:</span> <span class="hljs-string">__DB_PASSWORD__</span>
<span class="hljs-attr">            rawAccess:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">            port:</span> <span class="hljs-number">5432</span>
<span class="hljs-attr">            migrations:</span> <span class="hljs-literal">false</span></code></pre><h3>Compose Prisma Server in new docker machine</h3><pre><code class="hljs language-shell">docker compose up -d</code></pre><h3>Assign security group and check inbound rules</h3><ul><li>Basically, EC2 is assigned new security group as defalut. You need to check its inbound rule and open 4466 port.</li></ul><h3>Set the elastic load balancer (optional)</h3><h3>Modify prisma.yml</h3><pre><code class="hljs language-yml"><span class="hljs-attr">endpoint:</span> <span class="hljs-attr">http://__AWS_EC2_ADDRESS__:4466</span>
<span class="hljs-attr">datamodel:</span> <span class="hljs-string">datamodel.prisma</span>

<span class="hljs-attr">generate:</span>
<span class="hljs-attr">  - generator:</span> <span class="hljs-string">javascript-client</span>
<span class="hljs-attr">    output:</span> <span class="hljs-string">./generated/prisma-client/</span></code></pre><h3>Deploy datamodel.prisma to Prisma Server in AWS EC2</h3><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> PRISMA_MANAGEMENT_API_SECRET=__SECRET_KEY__ prisma deploy</span></code></pre><h3>Generate prisma client for GraphQL API</h3><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> prisma generate</span></code></pre><p>References</p><blockquote><p><a href="https://docs.docker.com/machine/drivers/aws/">https://docs.docker.com/machine/drivers/aws/</a> <a href="https://docs.docker.com/machine/examples/aws/#step-2-use-machine-to-create-the-instance">https://docs.docker.com/machine/examples/aws/#step-2-use-machine-to-create-the-instance</a></p></blockquote><hr/><h2>(Option 2) Using AWS ECS Cli</h2><h3>Create EC2 and ECS cluster</h3><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> ecs-cli up --keypair __AWS_KEYPAIR_NAME__ --capability-iam --vpc __SPECIFIC_VPC__ --subnets __SUBNET_1__,__SUBNET_2__ --size 1 --instance-type t2.micro --cluster-config prisma-server-ecs</span></code></pre><ul><li>It will generate the cloudformation which will proceed the whole process to generate EC2 instance and ECS cluster.</li></ul><h3>Compose the Prisma Server to ECS container</h3><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> ecs-cli compose up --create-log-groups --cluster-config prisma-server-ecs</span></code></pre><ul><li>It will generate the new Task definition. You can check the new Task definition is runnig.</li></ul><h3>Check if the new Task definition is running</h3><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> esc-cli ps</span></code></pre><ul><li>If your new Task definition is working well, you might want to make new service in ECS cluster in order to manage the task.</li></ul><p>References</p><blockquote><p><a href="https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/ECR_AWSCLI.html">https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/ECR_AWSCLI.html</a> &gt; <a href="https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/developerguide/ECS_CLI_tutorial_EC2.html">https://docs.aws.amazon.com/ko_kr/AmazonECS/latest/developerguide/ECS_CLI_tutorial_EC2.html</a></p></blockquote></div><style>
.index-h2-title {
  display: inline-block;
  border: 5px solid #2c3e50;
  border-radius: 35px;
  padding: 10px 20px;
  background-color: #fff;
}
.pinned {
  border: 5px solid #e74c3c;
}
#latest {
  color: #f39c12;
}
#pinned {
  color: #e74c3c;
}

.post-card {
  background-color: #fff;
  border: 1px solid #eee;
  padding: 20px;
  margin-bottom: 50px;
  border-radius: 5px;
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
}

img {
	width: 100%;
	max-width: fit-content;
}

blockquote {
  margin: 0;
  padding: 0 1em;
  color: #6a737d;
  border-left: 0.25em solid #dfe2e5;
	word-break: break-word;
}

code {
  color: #c0392b;
  padding: 2px 3px;
  border: 1px solid #ccc;
  border-radius: 3px;
}

pre code {
  overflow: auto;
  word-wrap: normal;
  white-space: pre;
  // width: calc(100vw - 360px);
}

/* a11y-dark theme */
/* Based on the Tomorrow Night Eighties theme: https://github.com/isagalaev/highlight.js/blob/master/src/styles/tomorrow-night-eighties.css */
/* @author: ericwbailey */

/* Comment */
.hljs-comment,
.hljs-quote {
  color: #d4d0ab;
}

/* Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
  color: #ffa07a;
}

/* Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
  color: #f5ab35;
}

/* Yellow */
.hljs-attribute {
  color: #ffd700;
}

/* Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
  color: #abe338;
}

/* Blue */
.hljs-title,
.hljs-section {
  color: #00e0e0;
}

/* Purple */
.hljs-keyword,
.hljs-selector-tag {
  color: #dcc6e0;
}

.hljs {
  display: block;
  overflow-x: auto;
  background: #2b2b2b;
  color: #f8f8f2;
  padding: 1rem;
  font-size: 1rem;
  border-radius: 5px;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

@media screen and (-ms-high-contrast: active) {
  .hljs-addition,
  .hljs-attribute,
  .hljs-built_in,
  .hljs-builtin-name,
  .hljs-bullet,
  .hljs-comment,
  .hljs-link,
  .hljs-literal,
  .hljs-meta,
  .hljs-number,
  .hljs-params,
  .hljs-string,
  .hljs-symbol,
  .hljs-type,
  .hljs-quote {
        color: highlight;
    }

    .hljs-keyword,
    .hljs-selector-tag {
        font-weight: bold;
    }
}

@media (max-width: 576px) {
  pre {
    width: calc(100vw - 60px);
  }
}
</style></div></div><div id="footer" class="jsx-1792980523"><div class="jsx-1792980523 footer-container"><div class="jsx-1792980523 footer-left-span"></div><div class="jsx-1792980523 copyright"><div class="jsx-1792980523">Copyright © 2018 Moondaddi&#x27;s Blog</div><div class="jsx-1792980523">The source code is under MIT License</div></div><div class="jsx-1792980523 footer-right-span"><a href="mailto:woonki.moon@gmail.com" class="jsx-1792980523"><i class="jsx-1792980523 fas fa-envelope"></i></a><a href="https://github.com/mattdamon108" target="_blank" class="jsx-1792980523"><i class="jsx-1792980523 fab fa-github"></i></a></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post","query":{"category":"backend","page":"1","filename":"2018-12-24-Deploy-Prisma-Server-to-AWS-with-Docker"},"buildId":"DmTcGCUL9fzETrbP8ToCP","nextExport":true}</script><script async="" id="__NEXT_PAGE__/post" src="/_next/static/DmTcGCUL9fzETrbP8ToCP/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/DmTcGCUL9fzETrbP8ToCP/pages/_app.js"></script><script src="/_next/static/runtime/webpack-f0c6edbea5b547edc23f.js" async=""></script><script src="/_next/static/chunks/commons.298c115416bea8464748.js" async=""></script><script src="/_next/static/runtime/main-ea256225ecf9df19827a.js" async=""></script></body></html>