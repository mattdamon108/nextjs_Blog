<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" class="next-head"/><title class="jsx-1456713024 next-head">Build the Codes</title><link rel="preload" href="/_next/static/n4M1jpVYalphfyXw7SKwN/pages/post.js" as="script"/><link rel="preload" href="/_next/static/n4M1jpVYalphfyXw7SKwN/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/n4M1jpVYalphfyXw7SKwN/pages/_error.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-2ef50c24cc8d478adafc.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.9f1d3f3f65945e0ea252.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-3a78f676ff0112da069d.js" as="script"/><style id="__jsx-3700472044">.header-container.jsx-3700472044{position:relative;margin:0 1rem;}
#header-title.jsx-3700472044{display:inline-block;font-family:var(--text-san-serif);font-size:1.4rem;margin:1rem auto;font-weight:bold;}
#header-title.jsx-3700472044 a.jsx-3700472044{-webkit-text-decoration:none;text-decoration:none;}
#header-body.jsx-3700472044{display:inline-block;position:absolute;right:0;margin:1rem auto;text-align:right;}
#menu.jsx-3700472044{display:inline-block;font-size:0.9rem;}
#menu.jsx-3700472044 #header-blog.jsx-3700472044{display:inline-block;margin:auto 1rem;}
#menu.jsx-3700472044 #header-tag.jsx-3700472044{display:inline-block;margin:auto 1rem;}
@media (max-width:576px){#header-title.jsx-3700472044{margin:1rem auto 0 auto;}#header-body.jsx-3700472044{display:block;text-align:right;position:relative;margin:0 auto;}}</style><style id="__jsx-583156192">#header.jsx-583156192{background-color:var(--background-color);color:white;}
.header-container.jsx-583156192{margin:0 1rem;padding:1rem 0;}
#header-title.jsx-583156192{display:block;position:relative;font-family:var(--text-san-serif);font-size:1.7rem;margin:1rem auto;font-weight:bold;}
#header-title.jsx-583156192 a.jsx-583156192{color:white;-webkit-text-decoration:none;text-decoration:none;}
#avatar-img.jsx-583156192{display:inline-block;-webkit-border-radius:25px;-moz-border-radius:25px;border-radius:25px;width:50px;height:50px;background-size:contain;background-repeat:no-repeat;background-position:center center;vertical-align:middle;}
#profile.jsx-583156192{display:inline-block;vertical-align:middle;padding-left:1rem;font-family:$font-serif;color:$text-normal-color;font-size:0.9rem;}
#header-body.jsx-583156192{position:relative;}
#menu.jsx-583156192{display:inline-block;position:absolute;right:0;font-family:$font-serif;font-size:0.9rem;margin-top:1rem;}
#menu.jsx-583156192 #header-tag.jsx-583156192{display:inline-block;margin:auto 1rem;}</style><style id="__jsx-967710577">#footer.jsx-967710577{background-color:var(--background-color);}
.container.jsx-967710577{width:null;}
.footer-container.jsx-967710577{-webkit-flex:1;-ms-flex:1;flex:1;padding:1rem;font-size:0.9rem;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}
.footer-body.jsx-967710577{font-family:var(--text-serif);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}
#footer-menu.jsx-967710577,#footer-contact.jsx-967710577,#footer-online.jsx-967710577{-webkit-flex:1;-ms-flex:1;flex:1;color:white;}
#footer-contact.jsx-967710577 div.jsx-967710577,#footer-online.jsx-967710577 div.jsx-967710577{text-align:center;}
.footer-copyright.jsx-967710577{color:white;}
@media screen and (max-width:576px){.footer-body.jsx-967710577{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}#footer-contact.jsx-967710577 div.jsx-967710577,#footer-online.jsx-967710577 div.jsx-967710577{text-align:left;}}
@media screen and (max-width:1200px){.container.jsx-967710577{width:null;}}</style><style id="__jsx-1456713024">html,body{width:100%;margin:0;padding:0;border:0;--background-color:#222f3e;--text-serif:Merriweather,Courier,serif;--text-san-serif:"Ubuntu","Helvetica Neue",Helvetica,Arial, sans-serif;--text-link-color:#ed4c67;}
body{font-size:1rem;font-family:var(--text-serif);font-weight:300;width:100%;line-height:200%;-webkit-font-smoothing:antialiased;}
a{-webkit-text-decoration:underline;text-decoration:underline;}
a:link{color:var(--text-link-color);}
a:visited{color:var(--text-link-color);}
a:hover{color:var(--text-link-color);}
a:active{color:var(--text-link-color);}
.container{width:800px;margin:0 auto;}
@media (max-width:900px){.container{width:100%;margin:0 auto;}}
.post-content{background-color:#fff;padding:1rem;margin-bottom:50px;}
img{width:100%;max-width:-webkit-fit-content;max-width:-moz-fit-content;max-width:fit-content;}
blockquote{margin:0;padding:0 1em;color:#6a737d;border-left:0.25em solid #dfe2e5;word-break:break-word;}
code{padding:2px 3px;border-width:0;border-radius:3px;background-color:rgba(255,229,100,0.2);font-family:Merriweather,Courier,serif;}
pre code{overflow:auto;word-wrap:normal;white-space:pre;line-height:150%;}
.hljs-comment,.hljs-quote{color:#d4d0ab;}
.hljs-variable,.hljs-template-variable,.hljs-tag,.hljs-name,.hljs-selector-id,.hljs-selector-class,.hljs-regexp,.hljs-deletion{color:#ffa07a;}
.hljs-number,.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-type,.hljs-params,.hljs-meta,.hljs-link{color:#f5ab35;}
.hljs-attribute{color:#ffd700;}
.hljs-string,.hljs-symbol,.hljs-bullet,.hljs-addition{color:#abe338;}
.hljs-title,.hljs-section{color:#00e0e0;}
.hljs-keyword,.hljs-selector-tag{color:#dcc6e0;}
.hljs{display:block;overflow-x:auto;background:#2b2b2b;color:#f8f8f2;padding:1rem;font-family:Consolas,Menlo,Monaco,monospace;font-size:0.8rem;font-weight:600;border-radius:5px;}
.hljs-emphasis{font-style:italic;}
.hljs-strong{font-weight:bold;}
@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-string,.hljs-symbol,.hljs-type,.hljs-quote{color:highlight;}.hljs-keyword,.hljs-selector-tag{font-weight:bold;}}
@media (max-width:576px){pre{width:100%;}}</style><meta name="author" content="moondaddi"/><link rel="apple-touch-icon" sizes="57x57" href="/static/favicons/apple-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/static/favicons/apple-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/static/favicons/apple-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/static/favicons/apple-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/static/favicons/apple-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/static/favicons/apple-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/static/favicons/apple-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/apple-icon-180x180.png"/><link rel="icon" type="image/png" sizes="192x192" href="/static/favicons/android-icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/static/favicons/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="#222f3e"/><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"/><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Merriweather" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=&quot;UA-136784454-1&quot;"></script><script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag("js", new Date());
        gtag("config", "UA-136784454-1");
			</script><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Build my dreams with codes"/><meta name="theme-color" content="#222f3e"/></head><body><div id="__next"><div id="header" class="jsx-3700472044"><div class="jsx-3700472044 container"><div class="jsx-3700472044 header-container"><div id="header-title" class="jsx-3700472044"><a href="/" class="jsx-3700472044">Build the Codes</a></div><div id="header-body" class="jsx-3700472044"><div id="menu" class="jsx-3700472044"><div id="header-blog" class="jsx-3700472044"><a href="/blog" class="jsx-3700472044">Blog</a></div><div id="header-tag" class="jsx-3700472044"><a href="/tag" class="jsx-3700472044">Tags</a></div></div></div></div></div></div><div id="content"><div class="container"><div class="post-content"><div><h1>How to warm your lambda function properly</h1><p>by moondaddi on 23 Mar 2019</p><hr/><p>It is fascinating to use a serverless framework like AWS lambda. It allows you to focus only codes and logic, not maintaining server or backend anymore. I deployed my service, <code>RateLink</code>(<a href="https://www.rate-link.com">link</a>), on AWS Lambda. It consists of the frontend web app and the backend GraphQL API. The Frontend web app is made of Next.js which is SSR framework with React. And the backend is a GraphQL node backend which is made of Express.js.</p><p>Right after I deployed it, I realized that it took almost 10 sec to see the web page. It happens to only very first-time access, after that everything seems fine. I found that it is so called <code>cold start</code> of lambda.</p><p>I googled it and found some remedies for the cold start. But, none of them works for my case. Because my Next.js app is quite big and needs to fetch a lot of data from the backend(which is also having a <code>cold start</code>) to render the whole page from the cold stage.</p><blockquote><p>Lambda goes to the cold stage after approx. 5 minutes idling.</p></blockquote><p>Here&#x27;s what I tried.</p><h3>1. AWS Cloudwatch Event 👎</h3><p>AWS Cloudwatch can invoke the lambda function in several ways. I try to make a periodical event to invoke my frontend and backend. But no gains. Because of how AWS Cloudwatch to invoke the lambda function. AWS Cloudwatch sends JSON data to the lambda function. But my frontend is a web app and my backend is a GraphQL API which respond to an HTTP request. JSON data is not enough to wake my frontend or backend app. JSON data will be carried with an event in lambda runtime. But none of my apps are responding to that event.</p><h3>2. Route53 health check 😱</h3><p>AWS Route53 has a feature to check the endpoint status, which is called a health check. You can turn it on to check the health of any endpoints. It pings the endpoint and checks the response status code. I found it works fine. It took about 2-3 sec to see the page rendered in first access. But the problem is the health check period is not adjustable. You can choose only 10 sec. or 30 sec. 10 sec means almost sending a ping per every sec, and 30 sec means ping per 2-3 sec. In calculating with it, it will send a ping almost 1.3M times per month (30pings/min <!-- -->*<!-- --> 60min <!-- -->*<!-- --> 24hrs <!-- -->*<!-- --> 30days = 1,296,000 pings/mon)😱</p><h3>3. Lambda Warmer 👍</h3><p>I made another lambda function to wake other lambdas up and keep it warm in every 5 min. Here are my code and serverless.yml.</p><pre><code class="hljs language-js"><span class="hljs-comment">// handler.js</span>

<span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;https&quot;</span>);

<span class="hljs-keyword">const</span> warming = <span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    https
      .get(url, res =&gt; {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;warmed! :&quot;</span>, res.statusCode);
        resolve(res);
      })
      .on(<span class="hljs-string">&quot;error&quot;</span>, e =&gt; {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;got error :&quot;</span>, e.message);
        reject(e);
      });
  });
};

<span class="hljs-built_in">module</span>.exports.warmer = <span class="hljs-keyword">async</span> (event, context, callback) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> warming(<span class="hljs-string">&quot;https://www.rate-link.com/rates&quot;</span>);
    context.succeed();
  } <span class="hljs-keyword">catch</span> (e) {
    context.done();
  }
};</code></pre><pre><code class="hljs language-yml"><span class="hljs-string">//</span> <span class="hljs-string">serverless.yml</span>

<span class="hljs-attr">service:</span> <span class="hljs-string">warmer</span>

<span class="hljs-attr">provider:</span>
<span class="hljs-attr">  name:</span> <span class="hljs-string">aws</span>
<span class="hljs-attr">  runtime:</span> <span class="hljs-string">nodejs8.10</span>
<span class="hljs-attr">  stage:</span> <span class="hljs-string">dev</span>
<span class="hljs-attr">  region:</span> <span class="hljs-string">ap-northeast-2</span>
<span class="hljs-attr">  profile:</span> <span class="hljs-string">{your</span> <span class="hljs-string">profile}</span>
<span class="hljs-attr">  memorySize:</span> <span class="hljs-number">128</span>
<span class="hljs-attr">  timeout:</span> <span class="hljs-number">15</span><span class="hljs-string">s</span>

<span class="hljs-attr">functions:</span>
<span class="hljs-attr">  warmer:</span>
<span class="hljs-attr">    handler:</span> <span class="hljs-string">handler.warmer</span>
<span class="hljs-attr">    events:</span>
<span class="hljs-attr">    - schedule:</span> <span class="hljs-string">rate(5</span> <span class="hljs-string">minutes)</span></code></pre><p>Since node8.10 in lambda runtime, <code>async/await</code> is available. I&#x27;ve made a request function <code>warming</code> and it returns a <code>Promise</code>. Then <code>handler.warmer</code> can call the warming function and it makes <code>await</code> till both frontend and backend app are running and respond to the request.</p><h2>Conclusion</h2><p>In the case of invoking a lambda function, you can use AWS Cloudwatch event for it. It means your lambda function takes an event in lambda runtime and run the function with it and return context or callback. But in case that you have a web app on lambda function which doesn&#x27;t depend on normal events, you need to send an HTTP request to your web app on lambda. It is not much help to send a JSON data to your apps to keep warm.</p></div></div></div></div><div id="header" class="jsx-583156192"><div class="jsx-583156192 container"><div class="jsx-583156192 header-container"><div id="header-title" class="jsx-583156192"><a href="/" class="jsx-583156192">Build the Codes</a></div><div id="header-body" class="jsx-583156192"><div id="avatar-img" style="background-image:url(&quot;/static/images/avatar/moondaddi_avatar.jpg&quot;)" class="jsx-583156192"></div><div id="profile" class="jsx-583156192"><div id="name" class="jsx-583156192"><a href="/" class="jsx-583156192">moondaddi</a></div><div class="jsx-583156192">My dreams with Codes</div></div><div id="menu" class="jsx-583156192"><div id="header-tag" class="jsx-583156192"><a href="/tag" class="jsx-583156192">Tags</a></div></div></div></div></div></div><div id="footer" class="jsx-967710577"><div class="jsx-967710577 container"><div class="jsx-967710577 footer-container"><div class="jsx-967710577 footer-body"><div id="footer-menu" class="jsx-967710577"><div class="jsx-967710577">moondaddi</div><div id="footer-email" class="jsx-967710577"><a href="mailto:woonki.moon@gmail.com" class="jsx-967710577">woonki.moon@gmail.com</a></div></div><div id="footer-contact" class="jsx-967710577"><div class="jsx-967710577"><a href="/blog" class="jsx-967710577">Blog</a></div><div class="jsx-967710577"><a href="/tag" class="jsx-967710577">Tag</a></div></div><div id="footer-online" class="jsx-967710577"><div class="jsx-967710577"><a href="https://github.com/mattdamon108" target="_blank" class="jsx-967710577">Github</a></div><div class="jsx-967710577"><a href="https://www.linkedin.com/in/woonki-moon-150a8b25/" target="_blank" class="jsx-967710577">Linkedin</a></div></div></div><div class="jsx-967710577 footer-copyright"><div class="jsx-967710577">Copyright (c) 2019 moondaddi</div><div class="jsx-967710577">under license MIT</div></div></div></div></div></div><script>__NEXT_DATA__ = {"props":{"pageProps":{}},"page":"/post","query":{"filename":"2019-03-23-how-to-warm-lambda-function"},"buildId":"n4M1jpVYalphfyXw7SKwN","nextExport":true};__NEXT_LOADED_PAGES__=[];__NEXT_REGISTER_PAGE=function(r,f){__NEXT_LOADED_PAGES__.push([r, f])}</script><script async="" id="__NEXT_PAGE__/post" src="/_next/static/n4M1jpVYalphfyXw7SKwN/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/n4M1jpVYalphfyXw7SKwN/pages/_app.js"></script><script async="" id="__NEXT_PAGE__/_error" src="/_next/static/n4M1jpVYalphfyXw7SKwN/pages/_error.js"></script><script src="/_next/static/runtime/webpack-2ef50c24cc8d478adafc.js" async=""></script><script src="/_next/static/chunks/commons.9f1d3f3f65945e0ea252.js" async=""></script><script src="/_next/static/runtime/main-3a78f676ff0112da069d.js" async=""></script></body></html>