<!DOCTYPE html><html lang="en"><head><meta name="author" content="Moondaddi"/><link rel="manifest" href="/static/manifest.json"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Build my dreams with codes"/><meta name="theme-color" content="black"/><meta charSet="utf-8" class="next-head"/><title class="next-head">Moondaddi&#x27;s Blog</title><link rel="preload" href="/_next/static/DmTcGCUL9fzETrbP8ToCP/pages/post.js" as="script"/><link rel="preload" href="/_next/static/DmTcGCUL9fzETrbP8ToCP/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-f0c6edbea5b547edc23f.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.298c115416bea8464748.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-ea256225ecf9df19827a.js" as="script"/><style id="__jsx-1792980523">.footer-container.jsx-1792980523{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.footer-left-span.jsx-1792980523{width:70px;}.copyright.jsx-1792980523{color:#999;font-size:0.8rem;text-align:center;padding:10px;}.footer-right-span.jsx-1792980523{color:#fff;font-size:1.5rem;text-align:right;}.footer-right-span.jsx-1792980523 a.jsx-1792980523:link,.footer-right-span.jsx-1792980523 a.jsx-1792980523:visited,.footer-right-span.jsx-1792980523 a.jsx-1792980523:hover,.footer-right-span.jsx-1792980523 a.jsx-1792980523:active{color:#fff;}.footer-right-span.jsx-1792980523 i.jsx-1792980523{padding-right:10px;}</style></head><body><div id="__next"><div id="layout"><div id="header" class="jsx-undefined"><div id="header-top" class="jsx-undefined"><div id="home" class="jsx-undefined"><div id="home-title" class="jsx-undefined"><a class="jsx-undefined" href="/">Build my Dreams with Codes</a></div><div id="home-title-sm" class="jsx-undefined"><a class="jsx-undefined" href="/">BDC</a></div></div><div id="menu" class="jsx-undefined"><a id="menu-about" class="jsx-undefined" href="/about/">About</a><i id="search-button-sm" class="jsx-undefined fa fa-search"></i><div id="search-container-id" class="jsx-undefined search-container"><span class="jsx-undefined icon"><i class="jsx-undefined fa fa-search"></i></span><input type="text" id="search" value="" class="jsx-undefined"/></div><div id="menu-button" class="jsx-undefined"><i class="jsx-undefined fas fa-bars"></i></div></div></div></div><div id="category" class="jsx-undefined"><div id="container-category" class="jsx-undefined"><div id="container-category-fixed" class="jsx-undefined"><div id="menu-close-button" class="jsx-undefined"><i class="jsx-undefined fas fa-times"></i></div><a id="selected" class="jsx-undefined" href="/post/react/"><span class="jsx-undefined">React</span><span class="jsx-undefined">4</span></a><a class="jsx-undefined" href="/post/django/"><span class="jsx-undefined">Django</span><span class="jsx-undefined">3</span></a><a class="jsx-undefined" href="/post/javascript/"><span class="jsx-undefined">Javascript</span><span class="jsx-undefined">0</span></a><a class="jsx-undefined" href="/post/python/"><span class="jsx-undefined">Python</span><span class="jsx-undefined">0</span></a><a class="jsx-undefined" href="/post/htmlcss/"><span class="jsx-undefined">Html CSS</span><span class="jsx-undefined">1</span></a><a class="jsx-undefined" href="/post/backend/"><span class="jsx-undefined">Backend</span><span class="jsx-undefined">3</span></a><a class="jsx-undefined" href="/post/devlogs/"><span class="jsx-undefined">dev logs</span><span class="jsx-undefined">5</span></a></div></div></div><div id="content"><div class="container"><div class="post-card"></div><div><h1>How to deploy the Next.js to AWS Lambda</h1><p>by moondaddi on 2019-01-11</p><hr/><p>This is a tiny example to show how to deploy the Next.js app on AWS Lambda using <a href="https://up.docs.apex.sh/#introduction">Apex Up</a>.</p><h2>Next.js app with custom server</h2><p>The custom server for Next.js app is needed to run your app on AWS Lambda. In this example, <code>express</code> will be used.</p><pre><code class="hljs language-javascript"><span class="hljs-comment">// server.js</span>

<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);
<span class="hljs-keyword">const</span> next = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;next&quot;</span>);

<span class="hljs-keyword">const</span> port = <span class="hljs-built_in">parseInt</span>(process.env.PORT, <span class="hljs-number">10</span>) || <span class="hljs-number">3000</span>;
<span class="hljs-keyword">const</span> dev = process.env.NODE_ENV !== <span class="hljs-string">&quot;production&quot;</span>;
<span class="hljs-keyword">const</span> app = next({ dev });
<span class="hljs-keyword">const</span> handle = app.getRequestHandler();

app
  .prepare()
  .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> server = express();

    server.get(<span class="hljs-string">&quot;/&quot;</span>, (req, res) =&gt; {
      <span class="hljs-keyword">return</span> app.render(req, res, <span class="hljs-string">&quot;/&quot;</span>, req.params);
    });

    server.get(<span class="hljs-string">&quot;/about&quot;</span>, (req, res) =&gt; {
      <span class="hljs-keyword">return</span> app.render(req, res, <span class="hljs-string">&quot;/about&quot;</span>, req.params);
    });

    server.get(<span class="hljs-string">&quot;*&quot;</span>, (req, res) =&gt; {
      <span class="hljs-keyword">return</span> handle(req, res);
    });

    server.listen(port, err =&gt; {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`&gt; Ready on http://localhost:<span class="hljs-subst">${port}</span>`</span>);
    });
  })
  .catch(<span class="hljs-function"><span class="hljs-params">ex</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(ex);
    process.exit(<span class="hljs-number">1</span>);
  });</code></pre><h2>update <code>package.json</code> with custom <code>server.js</code></h2><pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;scripts&quot;</span>: {
    <span class="hljs-attr">&quot;dev&quot;</span>: <span class="hljs-string">&quot;node server.js&quot;</span>,
    <span class="hljs-attr">&quot;build&quot;</span>: <span class="hljs-string">&quot;next build&quot;</span>,
    <span class="hljs-attr">&quot;start&quot;</span>: <span class="hljs-string">&quot;NODE_ENV=production node server.js&quot;</span>
  }
}</code></pre><h2>Install Apex Up</h2><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> curl -sf https://up.apex.sh/install | sh</span>
<span class="hljs-meta">
#</span><span class="bash"> verify the installation</span>
<span class="hljs-meta">$</span><span class="bash"> up version</span></code></pre><h2>AWS credentials</h2><p>You need to have one AWS account and recommend to use IAM with programmaic way for security and convinience. If you have already installed <code>awscli</code> or <code>awsebcli</code>, etc. You are having <code>~/.aws/credentials</code> which is storing AWS credentials. It allows you to use <code>AWS_PROFILE</code> environment. If you don&#x27;t please make one and save it with your account <code>access key</code> and <code>security key</code> in it.</p><pre><code class="hljs language-shell"><span class="hljs-meta">#</span><span class="bash"> ~/.aws/credentials</span>

[my-aws-account-for-lambda]
aws_access_key = xxxxxxxxxxxxx
aws_secret_access_key = xxxxxxxxxxxxxxxxxxxx</code></pre><h2>IAM policy for Up CLI</h2><p>IAM policy allows the Up to access your AWS resources in order to deploy your Next.js app on Lambda. Go to <a href="https://aws.amazon.com/iam/">AWS IAM</a> and make the new policy and link it up to your AWS account.</p><pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;Version&quot;</span>: <span class="hljs-string">&quot;2012-10-17&quot;</span>,
  <span class="hljs-attr">&quot;Statement&quot;</span>: [
    {
      <span class="hljs-attr">&quot;Effect&quot;</span>: <span class="hljs-string">&quot;Allow&quot;</span>,
      <span class="hljs-attr">&quot;Action&quot;</span>: [
        <span class="hljs-string">&quot;acm:*&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:Create*&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:Delete*&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:Describe*&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:ExecuteChangeSet&quot;</span>,
        <span class="hljs-string">&quot;cloudformation:Update*&quot;</span>,
        <span class="hljs-string">&quot;cloudfront:*&quot;</span>,
        <span class="hljs-string">&quot;cloudwatch:*&quot;</span>,
        <span class="hljs-string">&quot;ec2:*&quot;</span>,
        <span class="hljs-string">&quot;ecs:*&quot;</span>,
        <span class="hljs-string">&quot;events:*&quot;</span>,
        <span class="hljs-string">&quot;iam:AttachRolePolicy&quot;</span>,
        <span class="hljs-string">&quot;iam:CreatePolicy&quot;</span>,
        <span class="hljs-string">&quot;iam:CreateRole&quot;</span>,
        <span class="hljs-string">&quot;iam:DeleteRole&quot;</span>,
        <span class="hljs-string">&quot;iam:DeleteRolePolicy&quot;</span>,
        <span class="hljs-string">&quot;iam:GetRole&quot;</span>,
        <span class="hljs-string">&quot;iam:PassRole&quot;</span>,
        <span class="hljs-string">&quot;iam:PutRolePolicy&quot;</span>,
        <span class="hljs-string">&quot;lambda:AddPermission&quot;</span>,
        <span class="hljs-string">&quot;lambda:Create*&quot;</span>,
        <span class="hljs-string">&quot;lambda:Delete*&quot;</span>,
        <span class="hljs-string">&quot;lambda:Get*&quot;</span>,
        <span class="hljs-string">&quot;lambda:InvokeFunction&quot;</span>,
        <span class="hljs-string">&quot;lambda:List*&quot;</span>,
        <span class="hljs-string">&quot;lambda:RemovePermission&quot;</span>,
        <span class="hljs-string">&quot;lambda:Update*&quot;</span>,
        <span class="hljs-string">&quot;logs:Create*&quot;</span>,
        <span class="hljs-string">&quot;logs:Describe*&quot;</span>,
        <span class="hljs-string">&quot;logs:FilterLogEvents&quot;</span>,
        <span class="hljs-string">&quot;logs:Put*&quot;</span>,
        <span class="hljs-string">&quot;logs:Test*&quot;</span>,
        <span class="hljs-string">&quot;route53:*&quot;</span>,
        <span class="hljs-string">&quot;route53domains:*&quot;</span>,
        <span class="hljs-string">&quot;s3:*&quot;</span>,
        <span class="hljs-string">&quot;ssm:*&quot;</span>,
        <span class="hljs-string">&quot;sns:*&quot;</span>
      ],
      <span class="hljs-attr">&quot;Resource&quot;</span>: <span class="hljs-string">&quot;*&quot;</span>
    },
    {
      <span class="hljs-attr">&quot;Effect&quot;</span>: <span class="hljs-string">&quot;Allow&quot;</span>,
      <span class="hljs-attr">&quot;Action&quot;</span>: <span class="hljs-string">&quot;apigateway:*&quot;</span>,
      <span class="hljs-attr">&quot;Resource&quot;</span>: <span class="hljs-string">&quot;arn:aws:apigateway:*::/*&quot;</span>
    }
  ]
}</code></pre><h2>Create <code>up.json</code> file</h2><pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;nextjs-example&quot;</span>,
  # aws account profile in ~/.aws/credentials
  <span class="hljs-attr">&quot;profile&quot;</span>: <span class="hljs-string">&quot;my-aws-account-for-lambda&quot;</span>,
  <span class="hljs-attr">&quot;regions&quot;</span>: [<span class="hljs-string">&quot;ap-northeast-2&quot;</span>],
  <span class="hljs-attr">&quot;lambda&quot;</span>: {
    # min 128, default 512
    <span class="hljs-attr">&quot;memory&quot;</span>: <span class="hljs-number">256</span>,
    # AWS Lambda supports node.js 8.10 latest
    <span class="hljs-attr">&quot;runtime&quot;</span>: <span class="hljs-string">&quot;nodejs8.10&quot;</span>
  },
  <span class="hljs-attr">&quot;proxy&quot;</span>: {
    <span class="hljs-attr">&quot;command&quot;</span>: <span class="hljs-string">&quot;npm start&quot;</span>,
    <span class="hljs-attr">&quot;timeout&quot;</span>: <span class="hljs-number">25</span>,
    <span class="hljs-attr">&quot;listen_timeout&quot;</span>: <span class="hljs-number">15</span>,
    <span class="hljs-attr">&quot;shutdown_timeout&quot;</span>: <span class="hljs-number">15</span>
  },
  <span class="hljs-attr">&quot;stages&quot;</span>: {
    <span class="hljs-attr">&quot;development&quot;</span>: {
      <span class="hljs-attr">&quot;proxy&quot;</span>: {
        <span class="hljs-attr">&quot;command&quot;</span>: <span class="hljs-string">&quot;yarn dev&quot;</span>
      }
    }
  },
  <span class="hljs-attr">&quot;environment&quot;</span>: {
    # you can hydrate env variables as you want.
    <span class="hljs-attr">&quot;NODE_ENV&quot;</span>: <span class="hljs-string">&quot;production&quot;</span>
  },
  <span class="hljs-attr">&quot;error_pages&quot;</span>: {
    <span class="hljs-attr">&quot;variables&quot;</span>: {
      <span class="hljs-attr">&quot;support_email&quot;</span>: <span class="hljs-string">&quot;admin@my-email.com&quot;</span>,
      <span class="hljs-attr">&quot;color&quot;</span>: <span class="hljs-string">&quot;#2986e2&quot;</span>
    }
  }
}</code></pre><h2>Build the Next.js app before deploy</h2><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> yarn build</span></code></pre><h2>Create <code>.upignore</code> file</h2><p>The Up will inspect your files to compose and deploy to lambda. Firstly The up will read <code>.gitignore</code> and ignore files written in <code>.gitignore</code>. And after that, <code>.upignore</code> will be read. The Up, by default, ignores dotfiles, so needs to negate <code>.next</code> directory in <code>.upignore</code> in order for the Up will build the package with it.</p><pre><code class="hljs language-shell"><span class="hljs-meta">#</span><span class="bash"> .upignore</span>

!.next</code></pre><h2>Deploy</h2><pre><code class="hljs language-shell"><span class="hljs-meta">$</span><span class="bash"> up</span></code></pre></div><style>
.index-h2-title {
  display: inline-block;
  border: 5px solid #2c3e50;
  border-radius: 35px;
  padding: 10px 20px;
  background-color: #fff;
}
.pinned {
  border: 5px solid #e74c3c;
}
#latest {
  color: #f39c12;
}
#pinned {
  color: #e74c3c;
}

.post-card {
  background-color: #fff;
  border: 1px solid #eee;
  padding: 20px;
  margin-bottom: 50px;
  border-radius: 5px;
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
}

img {
	width: 100%;
	max-width: fit-content;
}

blockquote {
  margin: 0;
  padding: 0 1em;
  color: #6a737d;
  border-left: 0.25em solid #dfe2e5;
	word-break: break-word;
}

code {
  color: #c0392b;
  padding: 2px 3px;
  border: 1px solid #ccc;
  border-radius: 3px;
}

pre code {
  overflow: auto;
  word-wrap: normal;
  white-space: pre;
  // width: calc(100vw - 360px);
}

/* a11y-dark theme */
/* Based on the Tomorrow Night Eighties theme: https://github.com/isagalaev/highlight.js/blob/master/src/styles/tomorrow-night-eighties.css */
/* @author: ericwbailey */

/* Comment */
.hljs-comment,
.hljs-quote {
  color: #d4d0ab;
}

/* Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
  color: #ffa07a;
}

/* Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
  color: #f5ab35;
}

/* Yellow */
.hljs-attribute {
  color: #ffd700;
}

/* Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
  color: #abe338;
}

/* Blue */
.hljs-title,
.hljs-section {
  color: #00e0e0;
}

/* Purple */
.hljs-keyword,
.hljs-selector-tag {
  color: #dcc6e0;
}

.hljs {
  display: block;
  overflow-x: auto;
  background: #2b2b2b;
  color: #f8f8f2;
  padding: 1rem;
  font-size: 1rem;
  border-radius: 5px;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

@media screen and (-ms-high-contrast: active) {
  .hljs-addition,
  .hljs-attribute,
  .hljs-built_in,
  .hljs-builtin-name,
  .hljs-bullet,
  .hljs-comment,
  .hljs-link,
  .hljs-literal,
  .hljs-meta,
  .hljs-number,
  .hljs-params,
  .hljs-string,
  .hljs-symbol,
  .hljs-type,
  .hljs-quote {
        color: highlight;
    }

    .hljs-keyword,
    .hljs-selector-tag {
        font-weight: bold;
    }
}

@media (max-width: 576px) {
  pre {
    width: calc(100vw - 60px);
  }
}
</style></div></div><div id="footer" class="jsx-1792980523"><div class="jsx-1792980523 footer-container"><div class="jsx-1792980523 footer-left-span"></div><div class="jsx-1792980523 copyright"><div class="jsx-1792980523">Copyright © 2018 Moondaddi&#x27;s Blog</div><div class="jsx-1792980523">The source code is under MIT License</div></div><div class="jsx-1792980523 footer-right-span"><a href="mailto:woonki.moon@gmail.com" class="jsx-1792980523"><i class="jsx-1792980523 fas fa-envelope"></i></a><a href="https://github.com/mattdamon108" target="_blank" class="jsx-1792980523"><i class="jsx-1792980523 fab fa-github"></i></a></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post","query":{"category":"react","page":"1","filename":"2019-01-11-Deploy-Nextjs-app-to-AWS-Lambda"},"buildId":"DmTcGCUL9fzETrbP8ToCP","nextExport":true}</script><script async="" id="__NEXT_PAGE__/post" src="/_next/static/DmTcGCUL9fzETrbP8ToCP/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/DmTcGCUL9fzETrbP8ToCP/pages/_app.js"></script><script src="/_next/static/runtime/webpack-f0c6edbea5b547edc23f.js" async=""></script><script src="/_next/static/chunks/commons.298c115416bea8464748.js" async=""></script><script src="/_next/static/runtime/main-ea256225ecf9df19827a.js" async=""></script></body></html>